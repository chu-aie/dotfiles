#!/bin/bash

# {{ template "scripts-library" }}

# The following line is for ShellCheck to correctly identify the above include
true || source ../../.chezmoitemplates/scripts-library

# arguments usage
USAGE="DOCKER_NAME [-t|--type TYPE] [-v|--version VERSION] [-b|--build-path BUILD_PATH] [-u|--username USERNAME] [-d|--dockerfile-path DOCKERFILE_PATH] [-h|--help]"

# declare arguments
DOCKER_NAME=""
TYPE="runtime"
VERSION="latest"
BUILD_PATH=""
USERNAME="{{ .docker.username }}"
DOCKERFILE_PATH=""

set +u
# read arguments
# check first argument starts with a dash
# if it does, it's an option and DOCKER_NAME can be the last argument
# if not, it's the DOCKER_NAME
if [[ "$1" != -* ]]; then
  # if no arguments, print usage
  if [[ $# -eq 0 ]]; then
    echo "Usage: $0 $USAGE" >&2    
    exit 1
  fi
  DOCKER_NAME="$1"
  shift
fi
# parse options
while [[ $# -gt 0 ]]; do
  case "$1" in
  -t | --type)
    TYPE="$2"
    shift
    ;;
  --type=*)
    TYPE="${1#*=}"
    ;;
  -v | --version)
    VERSION="$2"
    shift
    ;;
  --version=*)
    VERSION="${1#*=}"
    ;;
  -b | --build-path)
    BUILD_PATH="$2"
    shift
    ;;
  --build-path=*)
    BUILD_PATH="${1#*=}"
    ;;
  -u | --username)
    USERNAME="$2"
    shift
    ;;
  --username=*)
    USERNAME="${1#*=}"
    ;;
  -d | --dockerfile-path)
    DOCKERFILE_PATH="$2"
    shift
    ;;
  --dockerfile-path=*)
    DOCKERFILE_PATH="${1#*=}"
    ;;
  -h | --help)
    echo "Usage: $0 $USAGE" >&2    
    exit 0
    ;;
  -h*)
    echo "Usage: $0 $USAGE" >&2
    exit 0
    ;;
  *)
    # if no option matches, it's the DOCKER_NAME
    if [[ -z "$DOCKER_NAME" ]]; then
      DOCKER_NAME="$1"
    else
      echo "Usage: $0 $USAGE" >&2
      exit 1
    fi
    ;;
  esac
  shift
done
set -u

# local variables
DOCKERFILES_REPO_DIR="${HOME}/.local/share/dockerfiles"
if [[ -z "$BUILD_PATH" ]]; then
  BUILD_PATH="${WORKSPACE_ROOT}/projects/${DOCKER_NAME}"
fi
if [[ -z "$DOCKERFILE_PATH" ]]; then
  DOCKERFILE_PATH="${DOCKERFILES_REPO_DIR}/${DOCKER_NAME}/Dockerfile.${TYPE}"
fi

TAG="${VERSION}-${TYPE}"
DOCKER_REPO="${USERNAME}/${DOCKER_NAME}:${TAG}"
if docker --version &>/dev/null; then
  log_task "Building ${DOCKER_REPO} for context ${BUILD_PATH}"
  c docker build --rm --force-rm -t "${DOCKER_REPO}" -f "${DOCKERFILE_PATH}" "${BUILD_PATH}"

  log_info "Successfully built ${DOCKER_REPO} with context ${BUILD_PATH}"

fi
