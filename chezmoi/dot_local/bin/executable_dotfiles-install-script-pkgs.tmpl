#!/bin/bash
# {{ template "scripts-library" }}

# check if --update or -u flag is set
set +u
if [[ "${1}" == "--update" ]] || [[ "${1}" == "-u" ]]; then
  UPDATE=true
else
  UPDATE=false
fi
set -u
log_task "Installing packages by scripts"

# shellcheck source=/dev/null
source "${HOME}/.config/shrc/05-package-list"

ensure_path_entry "${HOME}/.local/bin" "${HOME}/bin" "${HOME}/go/bin" "${HOME}/.cargo/bin"
GOROOT="${HOME}/go"
if [ -d "${HOME}/go/packages" ]; then
  export GOPATH
  export GOPATH="${GOROOT}/packages"
  ensure_path_entry "${GOPATH}/bin"
fi

DOTFILES_PKGS_SCRIPT=${DOTFILES_PKGS_SCRIPT:-()}
DOTFILES_PKGS_TO_INSTALL=${DOTFILES_PKGS_TO_INSTALL:-()}

wanted_packages=()
for package in "${DOTFILES_PKGS_SCRIPT[@]}"; do
  if is_item_in_array "${package}" "${DOTFILES_PKGS_TO_INSTALL[@]}"; then
    wanted_packages+=("${package}")
  fi
done
log_info "Wanted packages: ${wanted_packages[*]}"

{{- range .packages }}
{{- if and (hasKey . "script_cmd") ( .script_cmd ) }}
# installing {{ .name }}
PKG_NAME="{{ .name }}"
if is_item_in_array "${PKG_NAME}" "${wanted_packages[@]}"; then
  if {{ if and (hasKey . "check_prereqs") ( .check_prereqs ) }}{{ .check_prereqs }}{{ else }}true{{ end }}; then
    if {{ if and (hasKey . "check_installed") ( .check_installed ) }}{{ .check_installed }}{{ else }}command -v "${PKG_NAME}" &>/dev/null{{ end }}; then
      log_info "Package ${PKG_NAME} is already installed"
    else
      log_task "Installing ${PKG_NAME}"
      c {{ .script_cmd }}
    fi
  else
    log_error "Prerequisites for ${PKG_NAME} not met"
  fi
fi
{{- end }}
{{- end }}

log_green "âœ…  Packages installed by scripts successfully. âœ¨ ðŸŒŸ âœ¨"
