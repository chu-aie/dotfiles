#!/bin/bash

# {{ template "scripts-library" }}

# The following line is for ShellCheck to correctly identify the above include
true || source ../../.chezmoitemplates/scripts-library

set +u
FORCE=false
# check if --force or -f flag is set
if [[ "$1" == "--force" ]] || [[ "$1" == "-f" ]]; then
  FORCE=true
fi
set -u

if chezmoi --version &>/dev/null; then
  log_task "Pulling latest changes from dotfiles repo"
  # Pull latest changes from dotfiles repo
  chezmoi update --apply=false
fi
if dotdrop --version &>/dev/null; then
  DOTDROP_REPO="${HOME}/.config/dotdrop"

  log_task "Pulling latest changes from dotdrop repo"
  git -C "$DOTDROP_REPO" pull
fi
DOCKERFILES_REPO_DIR="${HOME}/.local/share/dockerfiles"
if [ -d "$DOCKERFILES_REPO_DIR" ]; then
    if git -C "$DOCKERFILES_REPO_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      log_task "Update dockerfiles repository"
      git -C "$DOCKERFILES_REPO_DIR" pull || true
    fi
fi

if chezmoi --version &>/dev/null; then
  log_task "Updating dotfiles for chezmoi"
  chezmoi init --force
  if [[ "$FORCE" == "true" ]]; then
    chezmoi apply --force
  else
    chezmoi apply
  fi
fi

if dotdrop --version &>/dev/null; then
  DOTDROP_PATH="$(which dotdrop)"

  log_task "Updating dotfiles for dotdrop"
  "${DOTDROP_PATH}" --cfg="${HOME}/.config/dotdrop/config-user.yaml" -p "{{ .dotdrop.user_profile }}" install
fi
